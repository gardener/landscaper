#!/bin/sh

# SPDX-FileCopyrightText: 2020 SAP SE or an SAP affiliate company and Gardener contributors
#
# SPDX-License-Identifier: Apache-2.0

# Script executed in case of a commit to a PR. The script checks if the comment of the commit contains "run-int-tests".
# In that case, the integration tests are executed by calling ./.ci/int-test. The parameter $PR_ID is integrated in the
# test cluster name. The cluster name has the format it-pr$PR_ID-<4-digits>.

set -o errexit
set -o nounset
set -o pipefail

echo "check if integration tests should be started"

if ! which git 1>/dev/null; then
  echo "Installing git... "
  apk add --no-cache --no-progress git
fi

PR_ID=$(git config -f pull-request-gardener.landscaper-pr.master/.git/config pullrequest.id)
echo "PR_ID: " $PR_ID

CURRENT_PATH="$(pwd)"
cd "${INTEGRATION_TEST_PATH}"
FULL_INTEGRATION_TEST_PATH="$(pwd)"
export FULL_INTEGRATION_TEST_PATH
cd "${CURRENT_PATH}"

SOURCE_PATH="$(dirname $0)/.."
cd "${SOURCE_PATH}"
SOURCE_PATH="$(pwd)"
export SOURCE_PATH

GIT_COMMENT=$(git show -s --format=%s)
echo "git comment: " $GIT_COMMENT

if git show -s --format=%s | grep run-int-tests; then
    echo "integration tests are started with FULL_INTEGRATION_TEST_PATH: "$FULL_INTEGRATION_TEST_PATH
    ./.ci/int-test $PR_ID | tee $INTEGRATION_TEST_PATH/ttt.log
    echo "integration tests finished with FULL_INTEGRATION_TEST_PATH: "$FULL_INTEGRATION_TEST_PATH
    cat $FULL_INTEGRATION_TEST_PATH/ttt.log
else
    echo "integration tests are skipped"
fi